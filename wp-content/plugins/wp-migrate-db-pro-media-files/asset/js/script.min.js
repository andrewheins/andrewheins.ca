var wpmdb=wpmdb||{};wpmdb.mediaFiles={remote_media_files_unavailable:!1},function(a,b){var c=0;Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},a(document).ready(function(){function d(h){if(0===Object.size(h.files_to_migrate))return 0===h.total_size?g(0,0,0):f(h),delete h.files_to_migrate,delete h.total_size,b.common.next_step_in_migration={fn:b.functions.determine_media_to_migrate_recursive,args:[h]},void b.functions.execute_next_step();var i=[],j=0,k=0;if(a.each(h.files_to_migrate,function(a,d){if("push"===wpmdb_migration_type()&&d>c){var e=wpmdbmf_strings.file_too_large+" "+a+" (#124mf)<br>";b.common.non_fatal_errors+=e}else if(i.length){if(j+d>h.bottleneck||k>=b.mediaFiles.remote_connection_data.media_files_max_file_uploads)return!1;i.push(a),j+=d}else i.push(a),j+=d;delete h.files_to_migrate[a],++h.media_progress_image_number,++k}),b.common.migration_error)return void b.functions.migration_complete_events();if(!i.length)return f(h),b.common.next_step_in_migration={fn:d,args:[h]},void b.functions.execute_next_step();var l=a.trim(a(".pull-push-connection-info").val()).split("\n");a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_migrate_media",file_chunk:i,remote_uploads_url:h.remote_uploads_url,intent:wpmdb_migration_type(),url:l[0],key:l[1],nonce:wpmdb_data.nonces.migrate_media},error:function(c,d,e){a(".progress-title").html(wpmdbmf_strings.migration_failed),a(".progress-text").not(".media").html(wpmdbGetAjaxErrors(wpmdbmf_strings.problem_migrating_media,"(#102mf)",c.responseText,c)),a(".progress-text").not(".media").addClass("migration-error"),console.log(c),console.log(d),console.log(e),b.common.migration_error=!0,b.functions.migration_complete_events()},success:function(c){var g=c;return(c=wpmdb_parse_json(a.trim(c)))?"undefined"!=typeof c.wpmdb_error&&1===c.wpmdb_error?void e(c.body):("undefined"!=typeof c.wpmdb_non_fatal_error&&1===c.wpmdb_non_fatal_error&&(b.common.non_fatal_errors+=c.body),h.media_progress+=j,f(h),b.common.next_step_in_migration={fn:d,args:[h]},void b.functions.execute_next_step()):void e(g)}})}function e(c){a(".progress-title").html(wpmdbmf_strings.migration_failed),a(".progress-text").not(".media").html(wpmdbGetAjaxErrors("","",c)),a(".progress-text").not(".media").addClass("migration-error"),a(".media-progress").fadeOut(),b.common.migration_error=!0,b.functions.migration_complete_events()}function f(a){var b=100*a.media_progress/a.total_size,c=b/100*a.total_files;g(b,Math.round(c),a.total_files)}function g(b,c,d){var e=Math.floor(b),f="migrate_media_files_"+wpmdb_migration_type();a(".media.progress-text").html(e+"% - "+wpmdbmf_strings[f]);var g="%";0===b&&(g="px"),a(".media.progress-bar").width(b+g);var h="";d>=0&&(h+="<span>"+wpmdbmf_strings.media_files+' (<span class="">'+wpmdb_add_commas(c)+"</span> / "+wpmdb_add_commas(d)+")</span>"),a(".media.progress-tables").html('<div title="" style="width: 100%;" class="progress-chunk media_files">'+h+"</div>")}function h(){return"1"===a("#media-files").attr("data-available")&&a("#media-files").is(":checked")?!0:!1}function i(b){a(b).is(":checked")&&"entire"===a(b).val()?(a("#remove-local-media").prop("disabled",!0),a("#remove-local-media").prop("checked",!1)):a("#remove-local-media").prop("disabled",!1)}"savefile"===wpmdb_migration_type()&&a(".media-files-options").hide();var j=function(){a("#media-files").attr("data-available","0"),a("#media-files").prop("checked",!1),a("#media-files").attr("disabled","disabled"),a(".media-files").addClass("disabled"),a(".media-files-options .expandable-content").hide()},k=function(c){var d=wpmdb_migration_type();return"savefile"===d?void a(".media-files-options").hide():(a(".media-files-options").show(),a(".media-files-push").hide(),c?(a(".media-files-options ul").hide(),a(".media-migration-unavailable").show(),void j()):"undefined"!=typeof b.mediaFiles.remote_connection_data&&wpmdb_data.media_files_version!==b.mediaFiles.remote_connection_data.media_files_version?(a(".media-files-remote-location").html(b.mediaFiles.remote_connection_data.url),a(".media-file-remote-version").html(b.mediaFiles.remote_connection_data.media_files_version),a(".media-files-different-plugin-version-notice").show(),void j()):(a(".media-files-options ul").show(),a(".media-migration-unavailable").hide(),a(".media-files-different-plugin-version-notice").hide(),a("#media-files").removeAttr("disabled"),a(".media-files").removeClass("disabled"),void a("#media-files").attr("data-available","1")))};a.wpmdb.add_action("move_connection_info_box",function(){k(b.mediaFiles.remote_media_files_unavailable),wpmdb_toggle_migration_action_text()}),a.wpmdb.add_action("verify_connection_to_remote_site",function(a){b.mediaFiles.remote_connection_data=a,b.mediaFiles.remote_media_files_unavailable="undefined"==typeof a.media_files_available,k(b.mediaFiles.remote_media_files_unavailable)}),a.wpmdb.add_filter("wpmdb_before_migration_complete_hooks",function(a){return!1===h()||"savefile"===wpmdb_migration_type()?a:(a.push(b.functions.prepare_remove_all_files),a)}),b.functions.prepare_remove_all_files=function(){b.mediaFiles.connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n");var c=a('input[name="media_migration_option"]:checked').val();if(a(".progress-tables").empty(),a(".progress-tables-hover-boxes").empty(),a(".progress-bar").width("0px"),"compare"!==c){var d="removing_all_files_"+wpmdb_migration_type();a(".progress-text").not(".media").html(wpmdbmf_strings[d]);var e={};e.remove_files=1,e.compare=0,e.offset=0,e.next_step_in_migration=b.functions.prepare_determine_media,b.common.next_step_in_migration={fn:b.functions.remove_files_recursive,args:[e]},b.functions.execute_next_step()}else b.common.next_step_in_migration={fn:b.functions.prepare_determine_media},b.functions.execute_next_step()},b.functions.remove_files_recursive=function(c){if(0===c.remove_files)return void(!1!==c.next_step_in_migration?(b.common.next_step_in_migration={fn:c.next_step_in_migration},b.functions.execute_next_step()):wpmdb_call_next_hook());b.mediaFiles.connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n");var d=c;a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_remove_files_recursive",compare:c.compare,offset:c.offset,intent:wpmdb_migration_type(),url:b.mediaFiles.connection_info[0],key:b.mediaFiles.connection_info[1],nonce:wpmdb_data.nonces.remove_files_recursive},error:function(c,d,e){a(".progress-title").html(wpmdbmf_strings.migration_failed),a(".progress-text").html(wpmdbGetAjaxErrors(wpmdbmf_strings.error_determining,"(#101mf)",c.responseText,c)),a(".progress-text").addClass("migration-error"),console.log(c),console.log(d),console.log(e),b.common.migration_error=!0,b.functions.migration_complete_events()},success:function(f){var g=f;return(c=wpmdb_parse_json(a.trim(f)))?"undefined"!=typeof c.wpmdb_error&&1===c.wpmdb_error?void e(c.body):("undefined"!=typeof c.wpmdb_non_fatal_error&&1===c.wpmdb_non_fatal_error&&(b.common.non_fatal_errors+=c.body),c.next_step_in_migration=d.next_step_in_migration,b.common.next_step_in_migration={fn:b.functions.remove_files_recursive,args:[c]},void b.functions.execute_next_step()):void e(g)}})},b.functions.prepare_determine_media=function(){b.mediaFiles.connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n"),c=0;var d=0,f=0,g=a('input[name="media_migration_option"]:checked').val();a(".progress-tables").empty(),a(".progress-tables").html('<div title="'+wpmdbmf_strings.media_files+'" style="width: 100%;" class="progress-chunk media_files"><span></div>'),a(".progress-text").not(".media").html("0% - "+wpmdbmf_strings.determining),"compare"===g?a("#remove-local-media").is(":checked")&&(d=1):f=1;var h={};a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_prepare_determine_media",intent:wpmdb_migration_type(),url:b.mediaFiles.connection_info[0],key:b.mediaFiles.connection_info[1],temp_prefix:b.common.connection_data.temp_prefix,nonce:wpmdb_data.nonces.prepare_determine_media},error:function(c,d,e){a(".progress-title").html(wpmdbmf_strings.migration_failed),a(".progress-text").html(wpmdbGetAjaxErrors(wpmdbmf_strings.error_determining,"(#101mf)",c.responseText,c)),a(".progress-text").addClass("migration-error"),console.log(c),console.log(d),console.log(e),b.common.migration_error=!0,b.functions.migration_complete_events()},success:function(g){var i=g;return(h=wpmdb_parse_json(a.trim(g)))?"undefined"!=typeof h.wpmdb_error&&1===h.wpmdb_error?void e(h.body):(c=h.remote_max_upload_size,h.determine_progress=0,h.remove_local_media=d,h.copy_entire_media=f,a(".progress-tables").html('<div title="'+wpmdbmf_strings.media_attachments+'" style="width: 100%;" class="progress-chunk media_files"><span>'+wpmdbmf_strings.media_attachments+' (<span class="">0</span> / '+wpmdb_add_commas(h.attachment_count)+")</span></div>"),b.common.next_step_in_migration={fn:b.functions.determine_media_to_migrate_recursive,args:[h]},void b.functions.execute_next_step()):void e(i)}})},b.functions.determine_media_to_migrate_recursive=function(c){return c.determine_progress===c.attachment_count?(a(".media-progress").hide(),a(".progress-bar").width("0px"),a(".progress-tables").empty(),b.common.next_step_in_migration={fn:b.functions.finalise_media_migration,args:[c]},void b.functions.execute_next_step()):(b.mediaFiles.connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n"),void a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_determine_media_to_migrate_recursive",determine_progress:c.determine_progress,attachment_count:c.attachment_count,remote_uploads_url:c.remote_uploads_url,remove_local_media:c.remove_local_media,copy_entire_media:c.copy_entire_media,prefix:c.prefix,blogs:c.blogs,attachment_batch_limit:c.attachment_batch_limit,intent:wpmdb_migration_type(),url:b.mediaFiles.connection_info[0],key:b.mediaFiles.connection_info[1],temp_prefix:b.common.connection_data.temp_prefix,nonce:wpmdb_data.nonces.determine_media_to_migrate_recursive},error:function(c,d,e){a(".progress-title").html(wpmdbmf_strings.migration_failed),a(".progress-text").not(".media").html(wpmdbmf_strings.error_determining+" (#101mf)"),a(".progress-text").not(".media").addClass("migration-error"),console.log(c),console.log(d),console.log(e),b.common.migration_error=!0,b.functions.migration_complete_events()},success:function(d){var f=d;if(d=wpmdb_parse_json(a.trim(d)),!d)return void e(f);if("undefined"!=typeof d.wpmdb_error&&1===d.wpmdb_error)return void e(d.body);c.blogs=d.blogs,c.determine_progress=d.determine_progress,c.total_size=d.total_size,c.files_to_migrate=d.files_to_migrate;var g=100*c.determine_progress/c.attachment_count,h=Math.floor(g);a(".progress-bar").not(".media").width(g+"%"),a(".progress-text").not(".media").html(h+"% - "+wpmdbmf_strings.determining),a(".progress-tables").not(".media").html('<div title="'+wpmdbmf_strings.media_attachments+'" style="width: 100%;" class="progress-chunk media_files"><span>'+wpmdbmf_strings.media_attachments+' (<span class="">'+wpmdb_add_commas(c.determine_progress)+"</span> / "+wpmdb_add_commas(c.attachment_count)+")</span></div>"),b.common.next_step_in_migration={fn:b.functions.media_successfully_determined,args:[c]},b.functions.execute_next_step()}}))},b.functions.media_successfully_determined=function(c){return"undefined"!=typeof c.wpmdb_error&&1===c.wpmdb_error?(b.common.non_fatal_errors+=data.body,b.common.next_step_in_migration={fn:wpmdb_call_next_hook},void b.functions.execute_next_step()):(c.media_progress=0,c.media_progress_image_number=0,c.bottleneck=wpmdb_data.max_request,c.total_files=Object.size(c.files_to_migrate),a(".media-progress").show(),g(0,0,c.total_files),b.common.next_step_in_migration={fn:d,args:[c]},void b.functions.execute_next_step())},b.functions.finalise_media_migration=function(c){if(1===c.remove_local_media){var d="removing_files_"+wpmdb_migration_type();return a(".progress-text").not(".media").html(wpmdbmf_strings[d]),c={},c.remove_files=1,c.compare=1,c.offset="",c.next_step_in_migration=!1,b.common.next_step_in_migration={fn:b.functions.remove_files_recursive,args:[c]},void b.functions.execute_next_step()}wpmdb_call_next_hook()},a('input[name="media_migration_option"]').each(function(){i(this)}),a('input[name="media_migration_option"]').change(function(){i(this)})})}(jQuery,wpmdb);